{
  "ruleChain": {
    "name": "Alter to call rpc",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "additionalInfo": {
      "description": ""
    }
  },
  "metadata": {
    "version": 10,
    "firstNodeIndex": 0,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.profile.TbDeviceProfileNode",
        "name": "device profile node",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "persistAlarmRulesState": false,
          "fetchAlarmRulesStateOnStart": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 73,
          "layoutY": 396
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 371,
          "layoutY": 399
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Shared Attributes",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "SHARED_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 885,
          "layoutY": 250
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save TimeSeries",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000722716
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 886,
          "layoutY": 361
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Other",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 890,
          "layoutY": 545
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rpc.TbSendRPCRequestNode",
        "name": "RPC Call Request",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "timeoutInSeconds": 60
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 890,
          "layoutY": 629
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log RPC from Devices",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 887,
          "layoutY": 461
        }
      },
      {
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "ESP32_002",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1763990602866
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "forwardMsgToDefaultRuleChain": false,
          "ruleChainId": "8e388f60-cb7c-11f0-b529-c7574d2602e9"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1792,
          "layoutY": 273
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Shared Attributes",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000722716
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "SHARED_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1789,
          "layoutY": 176
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Check Attribute",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000722716
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "var newMeta = {};\nvar newMsg;\nif(msg.temperature >= 50 || msg.temperature <= 15){\n    newMsg = { \"POWER\": \"ON\", \"additionalInfo\": null };\n}\n\nif(msg.temperature <= 30 && msg.temperature >=20){\n    newMsg = { \"POWER\": \"OFF\", \"additionalInfo\": null };\n}\n\nnewMeta = {\n    \"deviceName\": \"ESP32_002\",\n    \"deviceType\": \"default\",\n    \"notifyDevice\": \"false\"\n};\n\nvar newMsgType = \"POST_ATTRIBUTES_REQUEST\";\nreturn {\n    msg: newMsg,\n    metadata: newMeta,\n    msgType: newMsgType\n};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1482,
          "layoutY": 180
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Change Device",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000722716
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "originatorSource": "ENTITY",
          "preserveOriginatorIfCustomer": false,
          "entityType": "DEVICE",
          "entityNamePattern": "ESP32_002",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1195,
          "layoutY": 219
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Check RPC",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000917961
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "// ToDo\nvar newMsg;\nif(msg.temperature >= 50 || msg.temperature <= 15){\n    newMsg = { \"method\": \"POWER\", \"params\": \"ON\", \"additionalInfo\": null };\n}\n\nif(msg.temperature <= 30 && msg.temperature >= 20){\n    newMsg = { \"method\": \"POWER\", \"params\": \"OFF\", \"additionalInfo\": null };\n}\n\nvar newMetadata = { \n    \"deviceName\": \"ESP32_002\",\n    \"deviceType\": \"default\",\n    expirationTime: Date.now() + 4000,\n    oneway: false,\n    persistent: false\n};\nvar newMsgType = \"RPC_CALL_FROM_SERVER_TO_DEVICE\";\nreturn {\n    msg: newMsg,\n    metadata: newMetadata,\n    msgType: newMsgType\n};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1479,
          "layoutY": 269
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbCreateAlarmNode",
        "name": "Active",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1762866763397
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmDetailsBuildTbel": "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "useMessageAlarmData": false,
          "overwriteAlarmDetails": false,
          "alarmType": "active",
          "severity": "CRITICAL",
          "propagate": true,
          "relationTypes": [],
          "propagateToOwner": false,
          "propagateToOwnerHierarchy": false,
          "propagateToTenant": false,
          "dynamicSeverity": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 887,
          "layoutY": 163
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbClearAlarmNode",
        "name": "Not Active",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1762866763397
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmDetailsBuildTbel": "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmType": "inactive"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 882,
          "layoutY": 66
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "alter",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 1764000722716
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return msg.temperature > 20;",
          "tbelScript": "if( msg.long == 106.65789107082472 &&msg.lat == 10.772175109674038){\n    return true; \n}\n\nif( msg.long == 106.80633605864662 && msg.lat == 10.880018410410052 ){\n    return false; \n}\n\n"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1194,
          "layoutY": 359
        }
      },
      {
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "ESP32_001",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "forwardMsgToDefaultRuleChain": false,
          "ruleChainId": "1adc0360-d26d-11f0-b529-c7574d2602e9"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1812,
          "layoutY": 533
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Shared Attributes",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "SHARED_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1809,
          "layoutY": 436
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Check Attribute",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "var newMeta = {};\nvar newMsg;\nif(msg.temperature >= 50 || msg.temperature <= 15){\n    newMsg = { \"POWER\": \"ON\", \"additionalInfo\": null };\n}\n\nif(msg.temperature <= 30 && msg.temperature >=20){\n    newMsg = { \"POWER\": \"OFF\", \"additionalInfo\": null };\n}\n\nnewMeta = {\n    \"deviceName\": \"ESP32_001\",\n    \"deviceType\": \"default\",\n    \"notifyDevice\": \"false\"\n};\n\nvar newMsgType = \"POST_ATTRIBUTES_REQUEST\";\nreturn {\n    msg: newMsg,\n    metadata: newMeta,\n    msgType: newMsgType\n};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1502,
          "layoutY": 440
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Change Device",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "originatorSource": "ENTITY",
          "preserveOriginatorIfCustomer": false,
          "entityType": "DEVICE",
          "entityNamePattern": "ESP32_001",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1215,
          "layoutY": 479
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Check RPC",
        "debugSettings": {
          "failuresEnabled": true,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "// ToDo\nvar newMsg;\nif(msg.temperature >= 50 || msg.temperature <= 15){\n    newMsg = { \"method\": \"POWER\", \"params\": \"ON\", \"additionalInfo\": null };\n}\n\nif(msg.temperature <= 30 && msg.temperature >= 20){\n    newMsg = { \"method\": \"POWER\", \"params\": \"OFF\", \"additionalInfo\": null };\n}\n\nvar newMetadata = { \n    \"deviceName\": \"ESP32_001\",\n    \"deviceType\": \"default\",\n    expirationTime: Date.now() + 4000,\n    oneway: false,\n    persistent: false\n};\nvar newMsgType = \"RPC_CALL_FROM_SERVER_TO_DEVICE\";\nreturn {\n    msg: newMsg,\n    metadata: newMetadata,\n    msgType: newMsgType\n};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1499,
          "layoutY": 529
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 2,
        "type": "Post attributes"
      },
      {
        "fromIndex": 1,
        "toIndex": 3,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 1,
        "toIndex": 4,
        "type": "Other"
      },
      {
        "fromIndex": 1,
        "toIndex": 5,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 1,
        "toIndex": 6,
        "type": "Post attributes"
      },
      {
        "fromIndex": 1,
        "toIndex": 6,
        "type": "RPC Request from Device"
      },
      {
        "fromIndex": 1,
        "toIndex": 6,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 1,
        "toIndex": 12,
        "type": "Activity Event"
      },
      {
        "fromIndex": 1,
        "toIndex": 13,
        "type": "Inactivity Event"
      },
      {
        "fromIndex": 3,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 14,
        "toIndex": 10,
        "type": "True"
      },
      {
        "fromIndex": 14,
        "toIndex": 18,
        "type": "False"
      },
      {
        "fromIndex": 17,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 18,
        "toIndex": 17,
        "type": "Success"
      },
      {
        "fromIndex": 18,
        "toIndex": 19,
        "type": "Success"
      },
      {
        "fromIndex": 19,
        "toIndex": 15,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}